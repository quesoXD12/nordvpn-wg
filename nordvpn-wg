#!/bin/bash
set -euo pipefail

# NordVPN WireGuard Config Generator
# Generates a WireGuard configuration file using NordVPN's API
#
# Usage: ./generate-wireguard-config.sh [options] [output-file]
#
# Options:
#   -c, --country COUNTRY   Filter by country code or name (e.g., us, switzerland)
#   -s, --server SERVER     Use specific server (e.g., us9574, us9574.nordvpn.com)
#   -i, --interactive       Interactive country selection using fzf (optional dependency)
#   -l, --list-countries    List available countries with WireGuard support
#   -h, --help              Show this help message
#
# Environment Variables:
#   NORDVPN_ACCESS_TOKEN    Your NordVPN access token (required)
#                           Get it from: https://my.nordaccount.com/dashboard/nordvpn/access-tokens/
#
# Examples:
#   ./generate-wireguard-config.sh                          # Best recommended server
#   ./generate-wireguard-config.sh -c us                    # Best US server
#   ./generate-wireguard-config.sh -c switzerland           # By country name
#   ./generate-wireguard-config.sh -i                       # Interactive fzf selection
#   ./generate-wireguard-config.sh -s us9574                # Specific server
#   ./generate-wireguard-config.sh -c de germany.conf       # German server, custom filename

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m' # No Color

# Default values
OUTPUT_FILE=""
COUNTRY=""
SERVER=""
LIST_COUNTRIES=false
INTERACTIVE=false

# Parse arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        -c|--country)
            COUNTRY="${2:-}"
            shift 2
            ;;
        -s|--server)
            SERVER="${2:-}"
            shift 2
            ;;
        -l|--list-countries)
            LIST_COUNTRIES=true
            shift
            ;;
        -i|--interactive)
            INTERACTIVE=true
            shift
            ;;
        -h|--help)
            echo "NordVPN WireGuard Config Generator"
            echo ""
            echo "Usage: $0 [options] [output-file]"
            echo ""
            echo "Options:"
            echo "  -c, --country COUNTRY   Filter by country code or name (e.g., us, switzerland)"
            echo "  -s, --server SERVER     Use specific server (e.g., us9574, us9574.nordvpn.com)"
            echo "  -i, --interactive       Interactive country selection using fzf"
            echo "  -l, --list-countries    List available countries with WireGuard support"
            echo "  -h, --help              Show this help message"
            echo ""
            echo "Environment Variables:"
            echo "  NORDVPN_ACCESS_TOKEN    Your NordVPN access token (required for config generation)"
            echo ""
            echo "Examples:"
            echo "  $0                              # Best recommended server"
            echo "  $0 -c us                        # Best US server"
            echo "  $0 -c switzerland              # By country name"
            echo "  $0 -i                           # Interactive fzf selection"
            echo "  $0 -s us9574                    # Specific server us9574"
            echo "  $0 -l                           # List all countries"
            exit 0
            ;;
        -*)
            echo -e "${RED}Error: Unknown option $1${NC}" >&2
            echo "Use --help for usage information."
            exit 1
            ;;
        *)
            OUTPUT_FILE="$1"
            shift
            ;;
    esac
done

# Check for required tools
for cmd in curl jq; do
    if ! command -v "$cmd" &> /dev/null; then
        echo -e "${RED}Error: '$cmd' is required but not installed.${NC}" >&2
        exit 1
    fi
done

# Function to list available countries
list_countries() {
    echo -e "${BLUE}=== Countries with WireGuard Support ===${NC}"
    echo ""
    echo -e "${YELLOW}Fetching country list...${NC}"
    
    # Get all countries that have WireGuard servers
    COUNTRIES=$(curl -sf "https://api.nordvpn.com/v1/servers/countries" | jq -r '.[] | "\(.code | ascii_downcase)\t\(.name)"' | sort)
    
    if [[ -z "$COUNTRIES" ]]; then
        echo -e "${RED}Error: Failed to fetch country list.${NC}" >&2
        exit 1
    fi
    
    echo ""
    echo -e "${BOLD}Code\tCountry${NC}"
    echo "────────────────────────────────"
    echo "$COUNTRIES" | while IFS=$'\t' read -r code name; do
        printf "%-6s\t%s\n" "$code" "$name"
    done
    echo ""
    echo -e "Use ${CYAN}-c <code>${NC} to select a country, e.g., ${CYAN}$0 -c us${NC}"
    if command -v fzf &> /dev/null; then
        echo -e "Or use ${CYAN}-i${NC} for interactive selection with fzf"
    fi
}

# Function for interactive country selection with fzf
select_country_interactive() {
    if ! command -v fzf &> /dev/null; then
        echo -e "${RED}Error: fzf is not installed.${NC}" >&2
        echo ""
        echo "Install fzf for interactive selection:"
        echo "  brew install fzf      # macOS"
        echo "  apt install fzf       # Debian/Ubuntu"
        echo "  pacman -S fzf         # Arch"
        echo ""
        echo "Or use -c <country> or -l to list countries."
        exit 1
    fi
    
    echo -e "${YELLOW}Fetching country list...${NC}" >&2
    
    COUNTRIES_JSON=$(curl -sf "https://api.nordvpn.com/v1/servers/countries")
    
    if [[ -z "$COUNTRIES_JSON" ]]; then
        echo -e "${RED}Error: Failed to fetch country list.${NC}" >&2
        exit 1
    fi
    
    # Format: "code | Country Name" for fzf display
    SELECTION=$(echo "$COUNTRIES_JSON" | \
        jq -r '.[] | "\(.code | ascii_downcase) | \(.name)"' | \
        sort -t'|' -k2 | \
        fzf --height=20 --reverse --prompt="Select country: " --header="Code | Country")
    
    if [[ -z "$SELECTION" ]]; then
        echo -e "${YELLOW}No country selected.${NC}" >&2
        exit 0
    fi
    
    # Extract the country code from selection
    echo "${SELECTION%% |*}"
}

# Handle list countries (doesn't require token)
if [[ "$LIST_COUNTRIES" == true ]]; then
    list_countries
    exit 0
fi

# Handle interactive mode
if [[ "$INTERACTIVE" == true ]]; then
    COUNTRY=$(select_country_interactive)
    echo ""
fi

# Check for access token (required for config generation)
if [[ -z "${NORDVPN_ACCESS_TOKEN:-}" ]]; then
    echo -e "${YELLOW}NORDVPN_ACCESS_TOKEN not set.${NC}"
    echo ""
    echo "Get your token from: https://my.nordaccount.com/dashboard/nordvpn/access-tokens/"
    echo ""
    
    # Check if we're in an interactive terminal
    if [[ -t 0 ]]; then
        echo -n "Enter your NordVPN access token: "
        read -rs NORDVPN_ACCESS_TOKEN
        echo ""  # newline after hidden input
        
        if [[ -z "$NORDVPN_ACCESS_TOKEN" ]]; then
            echo -e "${RED}Error: No token provided.${NC}" >&2
            exit 1
        fi
        
        echo ""
        echo -e "${CYAN}Tip:${NC} To skip this prompt, run:"
        echo "  export NORDVPN_ACCESS_TOKEN=\"your-token-here\""
        echo ""
    else
        echo -e "${RED}Error: No token provided and not in interactive mode.${NC}" >&2
        echo "Set the environment variable: export NORDVPN_ACCESS_TOKEN=\"your-token\""
        exit 1
    fi
fi

echo -e "${BLUE}=== NordVPN WireGuard Config Generator ===${NC}"
echo ""

# Step 1: Get private key
echo -e "${YELLOW}[1/3]${NC} Fetching your WireGuard private key..."
PRIVATE_KEY=$(curl -sf -u "token:${NORDVPN_ACCESS_TOKEN}" \
    "https://api.nordvpn.com/v1/users/services/credentials" \
    | jq -r '.nordlynx_private_key')

if [[ -z "$PRIVATE_KEY" || "$PRIVATE_KEY" == "null" ]]; then
    echo -e "${RED}Error: Failed to retrieve private key. Check your access token.${NC}" >&2
    exit 1
fi
echo -e "${GREEN}  ✓ Private key retrieved${NC}"

# Step 2: Get server info
echo -e "${YELLOW}[2/3]${NC} Finding WireGuard server..."

if [[ -n "$SERVER" ]]; then
    # Specific server requested
    # Clean up server name (remove .nordvpn.com if present)
    SERVER_NAME="${SERVER%.nordvpn.com}"
    
    echo -e "    Looking for server: ${CYAN}${SERVER_NAME}${NC}"
    
    SERVER_INFO=$(curl -sfg \
        "https://api.nordvpn.com/v1/servers?filters%5Bservers_technologies%5D%5Bidentifier%5D=wireguard_udp&filters%5Bhostname%5D=${SERVER_NAME}" \
        2>/dev/null || echo "[]")
    
    if [[ "$SERVER_INFO" == "[]" || -z "$SERVER_INFO" ]]; then
        echo -e "${RED}Error: Server '${SERVER_NAME}' not found or doesn't support WireGuard.${NC}" >&2
        echo ""
        echo "Tips:"
        echo "  - Use just the server name without domain (e.g., 'us9574' not 'us9574.nordvpn.com')"
        echo "  - Make sure the server supports WireGuard/NordLynx"
        echo "  - Use -l to list available countries, then pick a recommended server"
        exit 1
    fi
elif [[ -n "$COUNTRY" ]]; then
    # Country filter requested - supports both codes (us, ch) and names (switzerland)
    COUNTRY_LOWER=$(echo "$COUNTRY" | tr '[:upper:]' '[:lower:]')
    
    # Fetch countries list once
    COUNTRIES_JSON=$(curl -sf "https://api.nordvpn.com/v1/servers/countries")
    
    # Try matching by code first, then by name (partial match)
    COUNTRY_ID=$(echo "$COUNTRIES_JSON" | \
        jq -r ".[] | select(.code | ascii_downcase == \"${COUNTRY_LOWER}\") | .id")
    
    if [[ -z "$COUNTRY_ID" ]]; then
        # Try matching by country name (case-insensitive, partial match)
        MATCHING_COUNTRIES=$(echo "$COUNTRIES_JSON" | \
            jq -r ".[] | select(.name | ascii_downcase | contains(\"${COUNTRY_LOWER}\")) | \"\(.code | ascii_downcase)\t\(.name)\"")
        
        if [[ -z "$MATCHING_COUNTRIES" ]]; then
            MATCH_COUNT=0
        else
            MATCH_COUNT=$(echo "$MATCHING_COUNTRIES" | wc -l)
        fi
        
        if [[ "$MATCH_COUNT" -eq 0 ]]; then
            echo -e "${RED}Error: Country '${COUNTRY}' not found.${NC}" >&2
            echo ""
            echo "Use -l to list available countries, or try:"
            echo "  - 2-letter code: -c ch"
            echo "  - Full name: -c switzerland"
            echo "  - Partial name: -c switz"
            exit 1
        elif [[ "$MATCH_COUNT" -gt 1 ]]; then
            echo -e "${YELLOW}Multiple countries match '${COUNTRY}':${NC}" >&2
            echo ""
            echo "$MATCHING_COUNTRIES" | while IFS=$'\t' read -r code name; do
                echo "  -c $code  ($name)"
            done
            echo ""
            echo "Please be more specific or use the 2-letter code."
            exit 1
        fi
        
        # Single match - extract the ID
        COUNTRY_ID=$(echo "$COUNTRIES_JSON" | \
            jq -r ".[] | select(.name | ascii_downcase | contains(\"${COUNTRY_LOWER}\")) | .id")
    fi
    
    COUNTRY_NAME=$(echo "$COUNTRIES_JSON" | \
        jq -r ".[] | select(.id == ${COUNTRY_ID}) | .name")
    
    echo -e "    Filtering by country: ${CYAN}${COUNTRY_NAME}${NC}"
    
    SERVER_INFO=$(curl -sfg \
        "https://api.nordvpn.com/v1/servers/recommendations?filters%5Bservers_technologies%5D%5Bidentifier%5D=wireguard_udp&filters%5Bcountry_id%5D=${COUNTRY_ID}&limit=1")
else
    # No filter, get best recommended
    echo -e "    Getting best recommended server..."
    SERVER_INFO=$(curl -sfg \
        "https://api.nordvpn.com/v1/servers/recommendations?filters%5Bservers_technologies%5D%5Bidentifier%5D=wireguard_udp&limit=1")
fi

if [[ -z "$SERVER_INFO" || "$SERVER_INFO" == "[]" ]]; then
    echo -e "${RED}Error: Failed to get server information.${NC}" >&2
    exit 1
fi

# Extract server details
HOSTNAME=$(echo "$SERVER_INFO" | jq -r '.[0].hostname // .[0].hostname')
ENDPOINT=$(echo "$SERVER_INFO" | jq -r '.[0].station // .[0].station')
CITY=$(echo "$SERVER_INFO" | jq -r '.[0].locations[0].country.city.name // "Unknown"')
COUNTRY_NAME=$(echo "$SERVER_INFO" | jq -r '.[0].locations[0].country.name // "Unknown"')
PUBLIC_KEY=$(echo "$SERVER_INFO" | jq -r '.[0].technologies[] | select(.identifier == "wireguard_udp") | .metadata[] | select(.name == "public_key") | .value')
LOAD=$(echo "$SERVER_INFO" | jq -r '.[0].load // "?"')

if [[ -z "$PUBLIC_KEY" || "$PUBLIC_KEY" == "null" ]]; then
    echo -e "${RED}Error: Could not extract WireGuard public key from server.${NC}" >&2
    exit 1
fi

echo -e "${GREEN}  ✓ Found server: ${HOSTNAME}${NC}"
echo -e "    Location: ${CITY}, ${COUNTRY_NAME}"
echo -e "    Endpoint: ${ENDPOINT}:51820"
echo -e "    Current load: ${LOAD}%"

# Set output filename
DEFAULT_FILENAME="${HOSTNAME%.com}.conf"

if [[ -z "$OUTPUT_FILE" ]]; then
    echo ""
    echo -e "${BOLD}Where would you like to save the config?${NC}"
    echo "  1) Current directory (./$DEFAULT_FILENAME)"
    echo "  2) /etc/wireguard/ (system-wide, requires sudo)"
    echo "  3) Custom path"
    echo ""
    echo -n "Choice [1]: "
    read -r SAVE_CHOICE
    SAVE_CHOICE="${SAVE_CHOICE:-1}"
    
    case "$SAVE_CHOICE" in
        1)
            OUTPUT_FILE="./$DEFAULT_FILENAME"
            ;;
        2)
            OUTPUT_FILE="/etc/wireguard/$DEFAULT_FILENAME"
            USE_SUDO=true
            ;;
        3)
            echo -n "Enter full path: "
            read -r OUTPUT_FILE
            if [[ -z "$OUTPUT_FILE" ]]; then
                echo -e "${RED}Error: No path provided.${NC}" >&2
                exit 1
            fi
            # Expand ~ to home directory
            OUTPUT_FILE="${OUTPUT_FILE/#\~/$HOME}"
            ;;
        *)
            OUTPUT_FILE="./$DEFAULT_FILENAME"
            ;;
    esac
fi

# Step 3: Generate config
echo -e "${YELLOW}[3/3]${NC} Generating WireGuard config..."

CONFIG_CONTENT="# NordVPN WireGuard Configuration
# Server: ${HOSTNAME}
# Location: ${CITY}, ${COUNTRY_NAME}
# Generated: $(date -Iseconds)

[Interface]
PrivateKey = ${PRIVATE_KEY}
Address = 10.5.0.2/32
DNS = 103.86.96.100, 103.86.99.100

[Peer]
PublicKey = ${PUBLIC_KEY}
AllowedIPs = 0.0.0.0/0, ::/0
Endpoint = ${ENDPOINT}:51820
PersistentKeepalive = 25"

# Create directory if needed
OUTPUT_DIR=$(dirname "$OUTPUT_FILE")
if [[ ! -d "$OUTPUT_DIR" ]]; then
    if [[ "${USE_SUDO:-}" == "true" ]]; then
        sudo mkdir -p "$OUTPUT_DIR"
    else
        mkdir -p "$OUTPUT_DIR"
    fi
fi

# Write config
if [[ "${USE_SUDO:-}" == "true" ]]; then
    echo "$CONFIG_CONTENT" | sudo tee "$OUTPUT_FILE" > /dev/null
    sudo chmod 600 "$OUTPUT_FILE"
else
    echo "$CONFIG_CONTENT" > "$OUTPUT_FILE"
    chmod 600 "$OUTPUT_FILE"
fi

echo -e "${GREEN}  ✓ Config written to: ${OUTPUT_FILE}${NC}"

# Show wg-quick commands
if [[ "$OUTPUT_FILE" == /etc/wireguard/* ]]; then
    CONFIG_NAME=$(basename "$OUTPUT_FILE" .conf)
    echo ""
    echo -e "${CYAN}Connect:${NC} sudo wg-quick up $CONFIG_NAME"
    echo -e "${CYAN}Disconnect:${NC} sudo wg-quick down $CONFIG_NAME"
else
    echo ""
    echo -e "${CYAN}Connect:${NC} sudo wg-quick up $OUTPUT_FILE"
    echo -e "${CYAN}Disconnect:${NC} sudo wg-quick down $OUTPUT_FILE"
fi
